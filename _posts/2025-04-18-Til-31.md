---
title: "[TIL] DAY44 Spring Bean ìƒëª…ì£¼ê¸°, ì˜ˆì™¸ì²˜ë¦¬, JPQL"
categories: [ë‚´ì¼ë°°ì›€ìº í”„, TIL]
tag: [ê°œì¸ ê³¼ì œ, ë³¸ìº í”„, Spring, SpringBoot, BeanLifeCycle, ExceptionHandler, RestControllerAdvice, JPQL, JPA, Fetch join, n+1 ë¬¸ì œ]
date: 2025-04-18 20:20:00 +0900
toc_sticky: true
---
## ì˜¤ëŠ˜ ë°°ìš´ ê²ƒ
### ğŸ”Spring Bean ìƒëª…ì£¼ê¸°
#### ğŸ’¡ ìƒëª…ì£¼ê¸°ë€?
Spring Beanì˜ ìƒëª…ì£¼ê¸°ëŠ” **ê°ì²´ ìƒì„±ë¶€í„° ì†Œë©¸ê¹Œì§€**ì˜ ì „ ê³¼ì •ì„ ì˜ë¯¸í•˜ë©°, Springì´ ì§ì ‘ ê´€ë¦¬í•œë‹¤. ì´ ê³¼ì •ì—ì„œ íŠ¹ì • ì‹œì ì— **ì½œë°± ë©”ì„œë“œ**ë¥¼ í†µí•´ ì´ˆê¸°í™” ë˜ëŠ” ì¢…ë£Œ ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆë‹¤.

***
#### ğŸ” ìƒëª…ì£¼ê¸° íë¦„
1. Spring Container ìƒì„±
- `ApplicationContext`, `BeanFactory` ë“± ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™”
2. Bean ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
- ê¸°ë³¸ ìƒì„±ì ì‹¤í–‰ (ì‹±ê¸€í†¤ì€ ì‹œì‘ ì‹œì , í”„ë¡œí† íƒ€ì…ì€ ìš”ì²­ ì‹œ ìƒì„±)
3. ì˜ì¡´ì„± ì£¼ì… (DI)
- ìƒì„±ì/í•„ë“œ/Setter ë“±ì„ í†µí•´ ë‹¤ë¥¸ Bean ì£¼ì…
4. ì´ˆê¸°í™” ì½œë°±
- `@PostConstruct`, `InitializingBean.afterPropertiesSet()`, `@Bean(initMethod)`
5. Bean ì‚¬ìš©
6. ì†Œë©¸ì „ ì½œë°±
- `@PreDestroy`, `DisposableBean.destroy()`, `@Bean(destroyMethod)`
7. Spring ì¢…ë£Œ (Bean ì†Œë©¸)

***
#### â˜‘ï¸ ì½œë°± ë©”ì„œë“œ ì‚¬ìš© ë°©ë²•
1. InitializingBean / DisposableBean (ì¸í„°í˜ì´ìŠ¤ ë°©ì‹)

```java
public class MyBean implements InitializingBean, DisposableBean {

    @Override
    public void afterPropertiesSet() {
        System.out.println("ì´ˆê¸°í™” ë¡œì§ ì‹¤í–‰");
    }

    @Override
    public void destroy() {
        System.out.println("ì†Œë©¸ ë¡œì§ ì‹¤í–‰");
    }
}
```

> ë‹¨ì : Springì— ì˜ì¡´ì ì´ë©° ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ëŠ” ì ìš© ë¶ˆê°€

***
2. `@Bean(initMethod, destroyMethod)`

```java
@Bean(initMethod = "init", destroyMethod = "close")
public MyBean myBean() {
    return new MyBean();
}
```

- ë©”ì„œë“œëª…ì„ ììœ ë¡­ê²Œ ì§€ì • ê°€ëŠ¥
- ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œë„ ì ìš© ê°€ëŠ¥

***
3. `@PostConstruct`, `@PreDestory`

```java
@PostConstruct
public void init() {
    System.out.println("ì´ˆê¸°í™” ì‹¤í–‰");
}

@PreDestroy
public void destroy() {
    System.out.println("ì†Œë©¸ ì‹¤í–‰");
}
```

> ê°€ì¥ ê¶Œì¥ë˜ëŠ” ë°©ì‹, ìë°” í‘œì¤€ì´ë¯€ë¡œ Spring ì™¸ì—ì„œë„ ì‚¬ìš© ê°€ëŠ¥

***
#### ğŸ” Bean Scope

| Scope ìœ í˜•   | íŠ¹ì§•                                                                 |
|--------------|----------------------------------------------------------------------|
| Singleton    | ì• í”Œë¦¬ì¼€ì´ì…˜ ì „ì²´ì—ì„œ í•˜ë‚˜ì˜ ì¸ìŠ¤í„´ìŠ¤ ê³µìœ  (ê¸°ë³¸)                    |
| Prototype    | ìš”ì²­ ì‹œë§ˆë‹¤ ìƒˆë¡œìš´ ì¸ìŠ¤í„´ìŠ¤ ìƒì„± (ì†Œë©¸ì€ ì‚¬ìš©ìê°€ ì§ì ‘ ì²˜ë¦¬)         |
| Request      | ì›¹ ìš”ì²­ë§ˆë‹¤ ë³„ë„ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±                                       |
| Session      | ì‚¬ìš©ì ì„¸ì…˜ë§ˆë‹¤ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±                                        |
| Application  | ì„œë¸”ë¦¿ ì»¨í…ìŠ¤íŠ¸ ì „ì²´ì— ê±¸ì³ í•˜ë‚˜ì˜ ì¸ìŠ¤í„´ìŠ¤                         |

```java
@Scope("prototype")
@Bean
public MyBean myBean() {
    return new MyBean();
}
```

***
### âš ï¸ Spring ì˜ˆì™¸ ì²˜ë¦¬
#### ğŸ“Œ @ExceptionHandler
íŠ¹ì • ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ë°œìƒí•œ ì˜ˆì™¸ë¥¼ ì²˜ë¦¬í•˜ëŠ” ë©”ì„œë“œë¥¼ ì •ì˜

```java
@ExceptionHandler(IllegalArgumentException.class)
public ResponseEntity<?> handleException(IllegalArgumentException ex) {
    return ResponseEntity.badRequest().body(Map.of("error", ex.getMessage()));
}
```

> ë‹¨ì : ì»¨íŠ¸ë¡¤ëŸ¬ë§ˆë‹¤ ì¤‘ë³µ ì •ì˜ í•„ìš” â†’ ì „ì—­ ì²˜ë¦¬ë¡œ ê°œì„  í•„ìš”

***
#### ğŸ“Œ @RestControllerAdvice
- ì• í”Œë¦¬ì¼€ì´ì…˜ ì „ì—­ì—ì„œ ë°œìƒí•œ ì˜ˆì™¸ë¥¼ ì²˜ë¦¬
- JSON í˜•íƒœë¡œ ë°˜í™˜

```java
@RestControllerAdvice
public class GlobalExceptionHandler {

    @ExceptionHandler(IllegalArgumentException.class)
    public ResponseEntity<?> handleException(IllegalArgumentException ex) {
        return ResponseEntity.badRequest().body(Map.of("error", ex.getMessage()));
    }
}
```

| Annotation            | ëŒ€ìƒ ë²”ìœ„      | ë°˜í™˜ í˜•íƒœ | íŠ¹ì§•                    |
|----------------------|----------------|------------|-------------------------|
| `@ExceptionHandler`  | ë‹¨ì¼ ì»¨íŠ¸ë¡¤ëŸ¬  | ë·°/JSON    | ì»¨íŠ¸ë¡¤ëŸ¬ ë‚´ë¶€ ì˜ˆì™¸ì²˜ë¦¬ |
| `@ControllerAdvice`  | ëª¨ë“  ì»¨íŠ¸ë¡¤ëŸ¬  | ë·°         | ì „ì—­ ì˜ˆì™¸ ì²˜ë¦¬          |
| `@RestControllerAdvice` | ëª¨ë“  REST ì»¨íŠ¸ë¡¤ëŸ¬ | JSON       | API ì˜ˆì™¸ ì²˜ë¦¬ ê¶Œì¥ ë°©ì‹ |

***
### âœï¸ JPQL (Java Persistence Query Language)
#### âœï¸ JPQL ê°œìš”
- ê°ì²´(Entity)ë¥¼ ëŒ€ìƒìœ¼ë¡œ í•˜ëŠ” ì¿¼ë¦¬ ì–¸ì–´
- SQLê³¼ ìœ ì‚¬í•˜ì§€ë§Œ DB í…Œì´ë¸”ì´ ì•„ë‹Œ **Entityì™€ í•„ë“œ**ë¥¼ ëŒ€ìƒìœ¼ë¡œ í•¨

```java
String jpql = "SELECT p FROM Product p WHERE p.price > :minPrice";
List<Product> products = em.createQuery(jpql, Product.class)
                           .setParameter("minPrice", 1000)
                           .getResultList();
```

***
#### ğŸ“Œ ì£¼ìš” íŠ¹ì§• ë¹„êµ

| í•­ëª©           | JPQL                          | SQL                  |
|----------------|-------------------------------|----------------------|
| ëŒ€ìƒ           | Entity, í•„ë“œ                   | í…Œì´ë¸”, ì»¬ëŸ¼         |
| ë…ë¦½ì„±         | DB ë…ë¦½ì                      | DB ì¢…ì†              |
| ë¬¸ë²•           | ê°ì²´ì§€í–¥ ë¬¸ë²•                  | ê´€ê³„í˜• ë¬¸ë²•          |
| ê²°ê³¼ ë°˜í™˜ ë°©ì‹ | Entity, DTO, Object[] ê°€ëŠ¥     | Raw ResultSet        |

***
#### ğŸ“¦ ë°˜í™˜ íƒ€ì…
- `TypedQuery<T>`: íƒ€ì… ì•ˆì •ì„± ì œê³µ (ê¶Œì¥)
- `Query`: ë³µí•© íƒ€ì…ì¼ ë•Œ ì‚¬ìš© (Object[] ë°˜í™˜)

***
#### ğŸ”‘ íŒŒë¼ë¯¸í„° ë°”ì¸ë”©

```java
// ì´ë¦„ ê¸°ë°˜ ë°”ì¸ë”©
@Query("SELECT s FROM Student s WHERE s.name = :name")
List<Student> findByName(@Param("name") String name);
```

> ìˆœì„œ ê¸°ë°˜ íŒŒë¼ë¯¸í„°(`?1`)ëŠ” ê°€ë…ì„±ê³¼ ìœ ì§€ë³´ìˆ˜ì— ë¶ˆë¦¬í•˜ì—¬ ì§€ì–‘

***
#### ğŸ“š í”„ë¡œì ì…˜
- Entity ì „ì²´ê°€ ì•„ë‹Œ íŠ¹ì • í•„ë“œë§Œ ì¡°íšŒ ê°€ëŠ¥
- DTOë¡œ ë°˜í™˜í•˜ê±°ë‚˜ Object[] í˜•íƒœë¡œ ì²˜ë¦¬

```java
@Query("SELECT new com.example.StudentDto(s.name, s.age) FROM Student s")
List<StudentDto> findAllStudentDto();
```

***
#### ğŸ“Œ í˜ì´ì§• ì²˜ë¦¬

```java
List<Tutor> tutors = em.createQuery("SELECT t FROM Tutor t", Tutor.class)
                       .setFirstResult(0)
                       .setMaxResults(10)
                       .getResultList();
```

> setFirstResult = ì‹œì‘ ìœ„ì¹˜, setmaxResults = ì¡°íšŒ ê°œìˆ˜

***
### âš ï¸ Fetch Join & N+1 ë¬¸ì œ
#### ğŸš¨ N + 1 ë¬¸ì œ
ì§€ì—°ë¡œë”©(LAZY) ê´€ê³„ì—ì„œ ì¡°íšŒ ì‹œ ë°˜ë³µì ìœ¼ë¡œ ì¶”ê°€ ì¿¼ë¦¬ê°€ ì‹¤í–‰ë˜ì–´ ì„±ëŠ¥ ë¬¸ì œê°€ ë°œìƒ

```java
// íŠœí„° 3ëª… ì¡°íšŒ â†’ íšŒì‚¬ ì •ë³´ ê°ê° ì¡°íšŒ â†’ ì´ 4ê°œ ì¿¼ë¦¬ ì‹¤í–‰
List<Tutor> tutors = em.createQuery("SELECT t FROM Tutor t").getResultList();
for (Tutor t : tutors) {
    System.out.println(t.getCompany().getName());
}
```

***
#### âœ… Fetch Join

```java
@Query("SELECT t FROM Tutor t JOIN FETCH t.company")
List<Tutor> findTutorsWithCompany();
```

- ì—°ê´€ëœ ì—”í‹°í‹°ë¥¼ SQL í•œ ë²ˆì— ì¡°íšŒ
- N + 1 ë¬¸ì œ í•´ê²°
- `@OneToMany` (ì»¬ë™ì…˜) ì‚¬ìš© ì‹œ í˜ì´ì§• ì£¼ì˜

***
#### ğŸ§  @BatchSize
ì§€ì—° ë¡œë”©ëœ ì—”í‹°í‹°ë¥¼ ë¬¶ì–´ì„œ IN ì ˆë¡œ í•œ ë²ˆì— ì¡°íšŒ

```java
@BatchSize(size = 100)
@OneToMany(mappedBy = "company")
private List<Tutor> tutors;
```

- Hibernate ì„¤ì • (`hibernate.jdbc.batch_size`)ìœ¼ë¡œ ì„¤ì • ê°€ëŠ¥

***
### âœ¨ Spring Data JPAì—ì„œ JPQL ì‚¬ìš©
#### ğŸ§¾ @Query

```java
@Query("SELECT new com.example.dto.StudentDto(s.name, s.age) " +
       "FROM Student s WHERE s.name LIKE %:keyword% " +
       "AND s.age BETWEEN :minAge AND :maxAge")
List<StudentDto> search(@Param("keyword") String keyword,
                        @Param("minAge") int min,
                        @Param("maxAge") int max);
```

***
#### ğŸ’¬ íŠœí„°ë³„ í•™ìƒ ìˆ˜ ì¡°íšŒ

```java
@Query("SELECT new com.example.dto.TutorStudentCountDto(t.name, COUNT(s)) " +
       "FROM Tutor t JOIN t.students s GROUP BY t.name")
List<TutorStudentCountDto> findTutorStudentCounts();
```

***
#### ğŸ§ª í…ŒìŠ¤íŠ¸ ë°ì´í„° ì´ˆê¸°í™” (@PostConstruct)

```java
@Component
@Profile("dev")
public class DataInitializer {

    @PostConstruct
    public void init() {
        // íŠœí„°, í•™ìƒ í…ŒìŠ¤íŠ¸ ë°ì´í„° ì €ì¥
    }
}
```
